# Fluentd Configuration for Facial Recognition API
# Aggregates logs from all services and sends to Elasticsearch

# Input sources
<source>
  @type tail
  @id app_access_log
  path /app/logs/access.log
  pos_file /fluentd/buffer/app_access.pos
  tag app.access
  <parse>
    @type nginx
  </parse>
</source>

<source>
  @type tail
  @id app_error_log
  path /app/logs/error.log
  pos_file /fluentd/buffer/app_error.pos
  tag app.error
  <parse>
    @type multiline
    format_firstline /^\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2},\d{3}/
    format1 /^(?<time>\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2},\d{3}) - (?<logger>[\w\.]+) - (?<level>\w+) - (?<message>.*)$/
  </parse>
</source>

<source>
  @type tail
  @id nginx_access_log
  path /var/log/nginx/access.log
  pos_file /fluentd/buffer/nginx_access.pos
  tag nginx.access
  <parse>
    @type nginx
  </parse>
</source>

<source>
  @type tail
  @id nginx_error_log
  path /var/log/nginx/error.log
  pos_file /fluentd/buffer/nginx_error.pos
  tag nginx.error
  <parse>
    @type multiline
    format_firstline /\A\d{4}\/\d{2}\/\d{2} \d{2}:\d{2}:\d{2}/
    format1 /^(?<time>\d{4}\/\d{2}\/\d{2} \d{2}:\d{2}:\d{2}) \[(?<log_level>\w+)\] (?<pid>\d+).(?<tid>\d+): (?<message>.*)$/
  </parse>
</source>

# Filter: Add service metadata
<filter app.**>
  @type record_transformer
  <record>
    service facial-recognition-api
    environment production
    component flask-app
  </record>
</filter>

<filter nginx.**>
  @type record_transformer
  <record>
    service facial-recognition-api
    environment production
    component nginx
  </record>
</filter>

# Filter: Parse security-relevant events
<filter app.access>
  @type grep
  <regexp>
    key path
    pattern ^/api/(auth|enroll|consent)
  </regexp>
</filter>

<filter app.error>
  @type grep
  <regexp>
    key level
    pattern ERROR|WARNING
  </regexp>
</filter>

# Output to Elasticsearch
<match app.**>
  @type elasticsearch
  host elasticsearch
  port 9200
  index_name facial-api-app-${tag_suffix}
  logstash_format true
  logstash_prefix facial-api
  <buffer>
    @type file
    path /fluentd/buffer/app
    flush_mode interval
    flush_interval 10s
    retry_forever true
  </buffer>
</match>

<match nginx.**>
  @type elasticsearch
  host elasticsearch
  port 9200
  index_name facial-api-nginx-${tag_suffix}
  logstash_format true
  logstash_prefix facial-api
  <buffer>
    @type file
    path /fluentd/buffer/nginx
    flush_mode interval
    flush_interval 10s
    retry_forever true
  </buffer>
</match>

# Output security events to separate index
<match app.security>
  @type elasticsearch
  host elasticsearch
  port 9200
  index_name facial-api-security
  logstash_format true
  logstash_prefix facial-api-security
  <buffer>
    @type file
    path /fluentd/buffer/security
    flush_mode interval
    flush_interval 5s
    retry_forever true
  </buffer>
</match>
